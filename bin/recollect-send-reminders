#!/usr/bin/perl
use strict;
use warnings;
use FindBin;
use lib "$FindBin::Bin/../lib";
use Recollect::Notifier;
use Lazy::Lockfile;
use DateTime;
use Getopt::Long;

my $lockfile = "/var/www/recollect/run/send-reminders.lock";
my $lock = Lazy::Lockfile->new($lockfile);

my %args;
GetOptions( \%args,
    'debug',
);
$args{debug} = 1 if $ENV{RECOLLECT_DEBUG};

my $notifier = Recollect::Notifier->new;
my $reminders = $notifier->need_notification;
for my $r (@$reminders) {
    if ($args{debug}) {
        print "Would have notified reminder_id: $r\n";
        next;
    }
    eval { $notifier->notify($r) };
    if ($@) {
        my $now = localtime;
        warn "$now: $@";
    }
}

exit;

