upstream mod_perl {
    server 127.0.0.1:2080;
}

# Luke goofed up and told people to go to :5000, so lets make it work
 ^ domain.com$request_uri permanent;

server {
    listen 5000;
    server_name recollect.net;
    rewrite ^ recollect.net$request_uri permanent;
}

server {
    listen   80;
    server_name  recollect.net *.recollect.net;

    access_log /var/log/nginx/recollect-access.log;
    error_log  /var/log/nginx/recollect-error.log;

    root   /var/www/recollect/root;
    index  index.html;

    location ~ ^/(?:\d+\.\d+\.\d+)/javascript/(.+)\.jgz {
        rewrite ^/(?:\d+\.\d+\.\d+)\/(images|javascript|css)/(.*)$ /$1/$2;  
        expires max;
        types {}
        default_type application/javascript;
        add_header Content-Encoding "gzip";
        gzip off;
        break;
    }

    location ~ ^/(?:\d+\.\d+\.\d+)/(images|javascript|css) {
        rewrite ^/(?:\d+\.\d+\.\d+)\/(images|javascript|css)/(.*)$ /$1/$2;  
        expires max;  
        break;  
    }

    location / {
        proxy_redirect off;
        proxy_set_header   Host             $host;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

        error_page 404 =200 /404.html;
        error_page 500 502 503 504 /500.html;
        if (-f $request_filename/index.html) {
            rewrite (.*) $1/index.html break;
        }
        if (-f $request_filename) {
            rewrite (.*) $1 break;
        }
        if (-f $request_filename.html) {
            rewrite (.*) $1.html break;
        }
        if (!-f $request_filename) {
            proxy_pass http://mod_perl;
            break;
        }
    }
}

